import Storage from '../storage/index.js'
import * as Types from '../../../proto/autogenerated/ts/types.js'
import LND from '../lnd/index.js'

import { MainSettings } from './settings.js'

export default class {

    storage: Storage
    settings: MainSettings
    lnd: LND
    constructor(storage: Storage, lnd: LND, settings: MainSettings) {
        this.storage = storage
        this.settings = settings
        this.lnd = lnd
    }

    async AddProduct(userId: string, req: Types.AddProductRequest): Promise<Types.Product> {
        const user = await this.storage.GetUser(userId)
        const newProduct = await this.storage.productStorage.AddProduct(req.name, req.price_sats, user)
        return {
            id: newProduct.product_id,
            name: newProduct.name,
            price_sats: newProduct.price_sats,
        }
    }

    async NewProductInvoice(id: string): Promise<Types.NewInvoiceResponse> {
        const product = await this.storage.productStorage.GetProduct(id)
        const newInvoice = await this.lnd.NewInvoice(product.price_sats, product.name)
        await this.storage.AddUserInvoice(product.owner, newInvoice.paymentRequest, product)
        return {
            invoice: newInvoice.paymentRequest
        }
    }
}