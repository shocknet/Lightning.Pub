import Main from "./services/main/index.js"
import Nostr from "./services/nostr/index.js"
import { NostrSend, NostrSettings } from "./services/nostr/handler.js"
import * as Types from '../proto/autogenerated/ts/types.js'
import NewNostrTransport, { NostrRequest } from '../proto/autogenerated/ts/nostr_transport.js';
import { ERROR, getLogger } from "./services/helpers/logger.js";

export default (serverMethods: Types.ServerMethods, mainHandler: Main, nostrSettings: NostrSettings): { Stop: () => void, Send: NostrSend } => {
    const log = getLogger({})
    const nostrTransport = NewNostrTransport(serverMethods, {
        NostrUserAuthGuard: async (appId, pub) => {
            const app = await mainHandler.storage.applicationStorage.GetApplication(appId || "")
            const nostrUser = await mainHandler.storage.applicationStorage.GetOrCreateNostrAppUser(app, pub || "")
            return { user_id: nostrUser.user.user_id, app_user_id: nostrUser.identifier, app_id: appId || "" }
        },
        metricsCallback: metrics => mainHandler.settings.recordPerformance ? mainHandler.metricsManager.AddMetrics(metrics) : null,
        logger: { log: console.log, error: err => log(ERROR, err) }
    })
    const nostr = new Nostr(nostrSettings, event => {
        let j: NostrRequest
        try {
            j = JSON.parse(event.content)
            log("nostr event", j.rpcName || 'no rpc name')
        } catch {
            log(ERROR, "invalid json event received", event.content)
            return
        }
        if (j.authIdentifier !== event.pub) {
            log(ERROR, "authIdentifier does not match", j.authIdentifier || "--", event.pub)
            return
        }
        nostrTransport({ ...j, appId: event.appId }, res => {
            nostr.Send(event.appId, { type: 'content', pub: event.pub, content: JSON.stringify({ ...res, requestId: j.requestId }) })
        }, event.startAtNano, event.startAtMs)
    })
    return { Stop: () => nostr.Stop, Send: (...args) => nostr.Send(...args) }
}