import 'dotenv/config' // TODO - test env
import NewServer from '../proto/autogenerated/ts/express_server.js'
import NewClient from '../proto/autogenerated/ts/http_client.js'
import serverOptions from './auth.js';
import GetServerMethods from './services/serverMethods/index.js'
import Main, { LoadMainSettingsFromEnv } from './services/main/index.js'
import * as Types from '../proto/autogenerated/ts/types.js';
const testPort = 4000
var userAuthHeader = ""
const client = NewClient({
    baseUrl: `http://localhost:${testPort}`,
    retrieveAdminAuth: async () => (""),
    retrieveGuestAuth: async () => (""),
    retrieveUserAuth: async () => userAuthHeader,
    decryptCallback: async (b) => b,
    encryptCallback: async (b) => b,
    deviceId: "device0"
})
const mainHandler = new Main(LoadMainSettingsFromEnv(true)) // TODO - test env file
const server = NewServer(GetServerMethods(mainHandler), { ...serverOptions(mainHandler), throwErrors: true })
export const ignore = true

export const setup = async () => {
    await mainHandler.storage.Connect()
    await mainHandler.lnd.Warmup()
    server.Listen(testPort)
}
export const teardown = async () => {
    mainHandler.lnd.Stop()
    server.Close()
}


export default async (d: (message: string, failure?: boolean) => void) => {
    await client.Health()
    d("health ok")

    console.log(await client.LndGetInfo({ node_id: 0 }))
    d("lnd info ok")

    const res = await client.AddUser({ name: "test", callback_url: "http://...", secret: "shhhhhht" })
    if (res.status === 'ERROR') throw new Error(res.reason)
    console.log(res.result)
    const user = await mainHandler.storage.GetUser(res.result.user_id)
    console.log(user)
    userAuthHeader = res.result.auth_token
    d("create user ok")

    console.log(await client.NewAddress({ address_type: Types.AddressType.WITNESS_PUBKEY_HASH }))
    d("new address ok")
}
